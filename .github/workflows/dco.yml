name: DCO Check

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  dco:
    name: Verify Developer Certificate of Origin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check commits for DCO sign-off
        run: |
          # Get list of commits in this push/PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMITS=$(git log origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }} --format="%H")
          else
            COMMITS=$(git log -1 --format="%H")
          fi
          
          # Check each commit for sign-off
          MISSING_DCO=0
          for commit in $COMMITS; do
            MESSAGE=$(git log -1 --format="%B" $commit)
            if ! echo "$MESSAGE" | grep -q "^Signed-off-by: "; then
              echo "❌ Commit $commit is missing DCO sign-off"
              git log -1 --format="%h %s" $commit
              MISSING_DCO=1
            else
              echo "✅ Commit $commit has DCO sign-off"
            fi
          done
          
          if [ $MISSING_DCO -eq 1 ]; then
            echo ""
            echo "❌ One or more commits are missing DCO sign-off."
            echo "Please sign your commits with: git commit -s"
            echo "To fix existing commits: git rebase HEAD~N --signoff"
            exit 1
          fi
          
          echo ""
          echo "✅ All commits have DCO sign-off!"
